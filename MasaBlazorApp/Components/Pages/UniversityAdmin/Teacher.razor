@page "/UniversityAdmin/Teacher"
@layout Layout.UniversityAdminLayout
@rendermode InteractiveServer
@using Microsoft.Extensions.Caching.Memory
@using SchPeoManageWeb.Models
@using SchPeoManageWeb.Services
@using System.Text.RegularExpressions
@using SchPeoManageWeb.Utils
@using Microsoft.JSInterop
@inject IMemoryCache MemoryCache

<!--导航栏-->
<MCard Style="padding-left:0px;">
    <MTabs Height="45" BackgroundColor="white" Optional Style="padding-left:0;">
        <MTab OnClick="@(() =>{page="Teacher";_selected=new List<MTeacher>();})">
            课程信息
        </MTab>
        @if (_selectedTeacher == null)
        {
            <MTab Disabled>
                教师讲台信息
            </MTab>
        }
        else
        {
            <MTab OnClick="@(() =>{page="Class"; _selectedTeachingClass=new List<MTeachingClass>();})">
                @_selectedTeacher.Name 的讲台信息
            </MTab>
        }
    </MTabs>
</MCard>

<!--教师信息子页面-->
@if (page.Equals("Teacher"))
{
    <!--信息搜索框-->
    <MCard Class="mt-3">
        <MForm Model="searchModel" ValueChanged="onSearch">
            <MContainer>
                <MRow>
                    <MCol Cols="12"
                          Sm="6"
                          Md="4">
                        <MTextField @bind-Value="searchModel.SearchInfo"
                                    Clearable
                                    Outlined
                                    Dense
                                    HideDetails="@("auto")"
                                    Label="模糊搜索（教职工号/姓名/手机号/邮箱/职务等）">
                        </MTextField>
                    </MCol>
                    <MCol Cols="12"
                          Sm="6"
                          Md="3">
                        <MSelect Items="_allSchools"
                                 @bind-Value="searchModel.SchoolLimit"
                                 Clearable
                                 TItem="MSchool"
                                 TItemValue="int"
                                 TValue="int"
                                 Dense
                                 HideDetails="@("auto")"
                                 Outlined
                                 Label="学院"
                                 ItemValue="r => r.SchoolId"
                                 ItemText="r => r.SchoolName">
                        </MSelect>
                    </MCol>
                    <MCol Cols="12"
                          Sm="2"
                          Md="1"
                          Style="padding:18px 12px 5px  5px;">
                        <MCheckbox @bind-value="searchModel.Resigned" TValue="bool" OnChange="onSearch" Style="margin-top:0%; padding:0%;"><LabelContent>已离职</LabelContent></MCheckbox>
                    </MCol>
                    <MCol Cols="12"
                          Sm="2"
                          Md="1"
                          Style="padding:18px 12px 5px 5px;">
                        <MCheckbox @bind-value="searchModel.Deleted" TValue="bool" OnChange="onSearch" Style="margin-top:0%; padding:0%;"><LabelContent>已归档</LabelContent></MCheckbox>
                    </MCol>
                    <MCol Cols="12"
                          Sm="2"
                          Md="2"
                          Style="padding-top:13px;padding-bottom:0px;">
                        <MButton OnClick="onSearch">
                            <MIcon>mdi-card-search</MIcon>搜索
                        </MButton>
                    </MCol>
                </MRow>
            </MContainer>
        </MForm>
    </MCard>

    <!--教师信息表格主体-->
    ﻿<MDataTable Headers="_headers"
                     Items="@showTeachers"
                     @bind-Value="_selected"
                     TItem="MTeacher"
                     ItemKey="r => r.TeacherId.ToString()"
                     ItemsPerPage="10"
                     ShowSelect
                     SelectableKey="TeacherSelectable()"
                     Class="elevation-3 mt-5"
                     OnRowClick="OnTeacherRowClick"
                     OnItemSelect="@(r => {_selectedTeacher=r.Item1;})"
                     ResizeMode="_resizeMode"
                     FooterProps="@(props => {
                            props.PageText="第 "+(props.Pagination.PageStart+1).ToString()+" 项-第 "+(props.Pagination.PageStop).ToString()+" 项"+"   共"+(props.Pagination.ItemsLength)+"项";
})">
        <TopContent>
            <MSpacer></MSpacer>
            <MButton Elevation="3"
                     OnClick="AddTeacherInfo"
                     Color="accent"
                     Class="ml-3 mt-3">
                <MIcon Left
                       Class="mr-2"
                       Color="white">
                    mdi-account-plus
                </MIcon>
                添加
            </MButton>
            <MButton Elevation="3"
                     OnClick="GroupResignTeacherForm"
                     Color="accent"
                     Class="ml-3 mt-3">
                <MIcon Left
                       Class="mr-2"
                       Color="white">
                    mdi-account-remove
                </MIcon>
                离职
            </MButton>
            <MButton Elevation="3"
                     OnClick="GroupDeleteTeacherForm"
                     Color="accent"
                     Class="ml-3 mt-3">
                <MIcon Left
                       Class="mr-2"
                       Color="white">
                    mdi-delete
                </MIcon>
                归档
            </MButton>
        </TopContent>
        <ItemColContent>
            @if (context.Header.Value == "States")
            {
                @if (context.Item.EnrollmentDate == DateTime.MinValue || context.Item.EnrollmentDate > DateTime.Now)
                {
                    <MChip Class="ma-2"
                           Style="width:70px;
                                padding:5px;
                                align-content:center;
                                justify-content:center;
                                align-items:center;
                                text-align:center;
                                background-color:rgba(250,250,15,0.7);
                                border-radius: 5px;
                                border: 1px solid rgba(0, 0, 0, 0.1);">未入职</MChip>
                }
                else if (context.Item.IsDeleted)
                {
                    <MChip Class="ma-2" Disabled
                           Style="width:70px;
                                padding:5px;
                                align-content:center;
                                justify-content:center;
                                align-items:center;
                                text-align:center;
                             border-radius: 5px;
                             border: 1px solid rgba(0, 0, 0, 0.1);">已归档</MChip>
                }
                else if (context.Item.IsDeparted)
                {
                    <MChip Class="ma-2"
                           Style="width:70px;
                                padding:5px;
                                align-content:center;
                                justify-content:center;
                                align-items:center;
                                text-align:center;
                             background-color:rgba(200,200,200,0.25);
                             border-radius: 5px;
                             border: 1px solid rgba(0, 0, 0, 0.1);">已离职</MChip>
                }
                else if (context.Item.DepartedDate > DateTime.Today)
                {
                    <MChip Class="ma-2"
                           Style="width:70px;
                                padding:5px;
                                align-content:center;
                                justify-content:center;
                                align-items:center;
                                text-align:center;
                             background-color:rgba(255,165,0,0.25);
                             border-radius: 5px;
                             border: 1px solid rgba(0, 0, 0, 0.1);">即将离职</MChip>
                }
                else if (context.Item.ExpiryDate <= DateTime.Today && context.Item.IsDeparted == false)
                {
                    <MChip Class="ma-2"
                           Style="width:70px;
                                padding:5px;
                                align-content:center;
                                justify-content:center;
                                align-items:center;
                                text-align:center;
                                background-color:rgba(255,0,0,0.25);
                                border-radius: 5px;
                                border: 1px solid rgba(0, 0, 0, 0.1);">已到期</MChip>
                }
                else
                {
                    <MChip Class="ma-2"
                           Style="width:70px;
                                padding:5px;
                                align-content:center;
                                justify-content:center;
                                align-items:center;
                                text-align:center;
                             background-color:rgba(0,255,0,0.25);
                             border-radius: 5px;
                             border: 1px solid rgba(0, 0, 0, 0.1);">在职 </MChip>
                }

            }
            @if (context.Header.Value == "Actions")
            {
                <MIcon Style="margin-right:3px;"
                       title="查看"
                       Color="accent"
                       OnClick="() => ReadTeacherForm(context.Item)"
                       Icon="@("mdi-file")">
                </MIcon>
                @if (context.Item.IsDeleted == false && context.Item.IsDeparted == false)
                {
                    <MIcon Style="margin-right:3px;"
                           title="编辑"
                           Color="accent"
                           OnClick="() => EditTeacherForm(context.Item)"
                           Icon="@("mdi-pencil")">
                    </MIcon>
                }
                else
                {
                    <MIcon Style="margin-right:3px;"
                           title="编辑"
                           Color="accent"
                           Disabled
                           Icon="@("mdi-pencil")">
                    </MIcon>
                }
                @if (context.Item.IsDeleted == false && context.Item.IsDeparted == false && context.Item.EnrollmentDate != DateTime.MinValue && context.Item.EnrollmentDate <= DateTime.Today)
                {
                    <MIcon OnClick="() => ResignTeacherForm(context.Item)"
                           Style="margin-right:3px;"
                           Color="accent"
                           title="离职"
                           Icon="@("mdi-account-remove")">
                    </MIcon>
                }
                else
                {
                    <MIcon Disabled
                           Style="margin-right:3px;"
                           Color="accent"
                           title="离职"
                           Icon="@("mdi-account-remove")">
                    </MIcon>
                }
                @if (context.Item.IsDeleted == false)
                {
                    <MIcon title="归档"
                           Color="accent"
                           OnClick="() => DeleteTeacherForm(context.Item)"
                           Icon="@(" mdi-delete")">
                    </MIcon>
                }
                else
                {
                    <MIcon title="归档"
                           Color="accent"
                           Disabled
                           Icon="@(" mdi-delete")">
                    </MIcon>
                }

            }
            else
            {
                @context.Value
            }
        </ItemColContent>
    </MDataTable>
}
<!--教师执教的讲台信息子页面-->
@if(page.Equals("Class"))
{
<MCard Class="mt-3">
    <MCardTitle Style="padding-bottom:0;">@_selectedTeacher.Name 的讲台列表</MCardTitle>
    <MCardText Style="padding-left:0px;">
        <MDataTable ShowSelect
                    @bind-Value="_selectedTeachingClass"
                    ItemKey="r => r.ClassPMID"
                    Headers="_classHeader"
                    Items="_showTeachingClass"
                    SelectableKey="ClassSelectable()"
                    FooterProps="@(props => {
                        props.PageText="第 "+(props.Pagination.PageStart+1).ToString()+" 项-第 "+(props.Pagination.PageStop).ToString()+" 项"+"   共"+(props.Pagination.ItemsLength)+"项";
                        })">
            <TopContent>
                <MSpacer></MSpacer>
                <MButton Elevation="3"
                         Disabled
                         Color="accent"
                         Class="mt-3 ml-3">
                    <MIcon Left
                           Class="mr-2"
                           Color="white">
                        mdi-account-plus
                    </MIcon>
                    添加讲台
                </MButton>
                <MButton Elevation="3"
                         Disabled
                         Color="accent"
                         Class="ml-3 mt-3">
                    <MIcon Left
                           Class="mr-2"
                           Color="white">
                        mdi-delete
                    </MIcon>
                    归档
                </MButton>
            </TopContent>
        </MDataTable>
    </MCardText>
</MCard>
}


<!--添加教师信息按钮呼出的表单-->
<MRow Justify="JustifyTypes.Center">
    <MDialog @bind-Value="dialog"
             Persistent
             MaxWidth="900">
        <ActivatorContent>
        </ActivatorContent>
        <ChildContent>
            <MCard>
                <MCardTitle>
                    <span class="text-h5">添加教师信息</span>
                </MCardTitle>
                <MForm Model="mTeacher" @bind-Value="_valid" OnValidSubmit="SubmitTeacherInfo">
                    <MCardText>
                        <MContainer Style="border:solid 1px #82B1FF;padding-top:3;round-md;position:relative;">
                            <div style=" color: black; text-align: center; top: -13px; width: 110px; left: 3%; position: absolute; background: white;">基本信息</div>
                            <MRow>
                                <MCol Cols="12"
                                      Sm="6"
                                      Md="3">
                                    <MTextField Label="姓名*"
                                                @bind-Value="mTeacher.Name"
                                                TValue="string"
                                                Autofocus
                                                Required
                                                RequiredMessage="请输入教师姓名"
                                                HideDetails="@("auto")"
                                                Dense
                                                Outlined>
                                    </MTextField>
                                </MCol>
                                <MCol Cols="12"
                                      Sm="6"
                                      Md="3">
                                    <MSelect @bind-Value="mTeacher.Sex"
                                             Items="@(Enum.GetNames(typeof(Sexs)).Select(name => name).ToList())"
                                             ItemText="r => r" ItemValue="r => r"
                                             Label="性别*"
                                             SingleLine
                                             Required
                                             RequiredMessage="请选择性别"
                                             HideDetails="@("auto")"
                                             Dense
                                             Outlined></MSelect>

                                </MCol>
                                <MCol Cols="12"
                                      Sm="6"
                                      Md="6">
                                    <MTextField Label="联系电话"
                                                Type="number"
                                                @bind-Value="mTeacher.PhoneNumber"
                                                TValue="string"
                                                Rules="Command.PhoneRule"
                                                NumberProps="@(prop => { prop.HideControl = true; })"
                                                HideDetails="@("auto")"
                                                Dense
                                                Outlined>
                                    </MTextField>
                                </MCol>
                                <MCol Cols="12"
                                      Sm="6"
                                      Md="6">
                                    <MTextField Label="身份证号*"
                                                @bind-Value="mTeacher.IdNumber"
                                                TValue="string"
                                                RequiredMessage="请输入身份证号"
                                                Required
                                                Rules="Command.IDRule"
                                                HideDetails="@("auto")"
                                                Dense
                                                Outlined>
                                    </MTextField>
                                </MCol>
                                <MCol Cols="12"
                                      Sm="6"
                                      Md="6">
                                    <MTextField Label="联系邮箱"
                                                @bind-Value="mTeacher.Email"
                                                TValue="string"
                                                Rules="Command.MailRule"
                                                PersistentHint
                                                HideDetails="@("auto")"
                                                Dense
                                                Outlined></MTextField>
                                </MCol>
                            </MRow>
                        </MContainer>

                        <MContainer Style="margin-top:4%; border:solid 1px #82B1FF; position:relative;">
                            <div style=" color: black; text-align: center; top:-13px;width: 110px; left: 3%; position: absolute; background: white;">就职信息</div>
                            <MRow Style="margin-top:1%;">
                                <MCol Cols="12"
                                      Sm="6"
                                      Md="6">
                                    <MTextField Label="教职工号*"
                                                @bind-Value="mTeacher.EmployeeID"
                                                TValue="string"
                                                ValidateOnBlur
                                                Rules="Command.EmpIDRule"
                                                NumberProps="@(prop => { prop.HideControl = true; })"
                                                HideDetails="@("auto")"
                                                Dense
                                                Required
                                                Outlined>
                                    </MTextField>
                                </MCol>
                                <MCol Cols="12"
                                      Sm="3"
                                      Md="3">
                                    <MSpacer></MSpacer>
                                    @if (_enrollmentDate == DateOnly.MinValue)
                                    {
                                        <MTextField Label="入职日期"
                                                    TValue="string"
                                                    Value="@("yyyy-mm-dd")"
                                                    Dense
                                                    HideDetails="@("auto")"
                                                    Readonly
                                                    AppendIcon="mdi-calendar-range"
                                                    OnMouseUp="() => _enrollC = true"
                                                    OnAppendClick="() => _enrollC = true">
                                        </MTextField>
                                    }
                                    else
                                    {
                                        <MTextField Label="入职日期"
                                                    TValue="DateOnly"
                                                    ValidateOnBlur
                                                    Dense
                                                    HideDetails="@("auto")"
                                                    @bind-Value="_enrollmentDate"
                                                    Readonly
                                                    AppendIcon="mdi-calendar-range"
                                                    OnMouseUp="() => _enrollC = true"
                                                    OnAppendClick="() => _enrollC = true">
                                        </MTextField>
                                    }
                                </MCol>
                                <MCol Cols="12"
                                      Sm="3"
                                      Md="3">
                                    @if (_expiryDate == DateOnly.MinValue)
                                    {
                                        <MTextField Label="合同到期日期"
                                                    TValue="string"
                                                    Value="@("yyyy-mm-dd")"
                                                    Dense
                                                    HideDetails="@("auto")"
                                                    Readonly
                                                    AppendIcon="mdi-calendar-range"
                                                    OnMouseUp="() => _expiryC = true"
                                                    OnAppendClick="() => _expiryC = true">
                                        </MTextField>
                                    }
                                    else
                                    {
                                        <MTextField Label="合同到期日期"
                                                    TValue="DateOnly"
                                                    ValidateOnBlur
                                                    Dense
                                                    HideDetails="@("auto")"
                                                    @bind-Value="_expiryDate"
                                                    Readonly
                                                    AppendIcon="mdi-calendar-range"
                                                    OnMouseUp="() => _expiryC = true"
                                                    OnAppendClick="() => _expiryC = true">
                                        </MTextField>
                                    }
                                </MCol>
                                <MCol Cols="12"
                                      Sm="6"
                                      Md="3">
                                    <MSelect @bind-Value="mTeacher.IsBudgetedPosts"
                                             Items="@(Enum.GetNames(typeof(YesNo)).Select(name => name).ToList())"
                                             ItemText="r => r.ToString()"
                                             ItemValue="r => r.Equals(yes)?true:false"
                                             Label="是否有编制*"
                                             Required
                                             RequiredMessage="请选择是否有编制"
                                             Dense
                                             HideDetails="@("auto")"
                                             Outlined></MSelect>
                                </MCol>
                                <MCol Cols="12"
                                      Sm="6"
                                      Md="3">
                                    <MSelect TItem="MData"
                                             TValue="string"
                                             TItemValue="string"
                                             Items="_jobTitleItems"
                                             @bind-Value="mTeacher.JobTitle"
                                             Label="职称"
                                             ItemValue="r => r.Name"
                                             ItemText="r => r.Name"
                                             RequiredMessage="请选择职称"
                                             HideDetails="@("auto")"
                                             Dense
                                             Outlined>
                                    </MSelect>
                                </MCol>
                                <MCol Cols="12"
                                      Sm="6"
                                      Md="3">
                                    <MTextField TValue="string"
                                                @bind-Value="mTeacher.JobPosition"
                                                Label="职务"
                                                RequiredMessage="请输入职务*"
                                                Dense
                                                HideDetails="@("auto")"
                                                Outlined>
                                    </MTextField>
                                </MCol>
                                <MCol Cols="12"
                                      Sm="6"
                                      Md="3">
                                    <MSelect Items="_allSchools"
                                             TItem="MSchool"
                                             TItemValue="int"
                                             TValue="int"
                                             @bind-Value="mTeacher.SchoolId"
                                             Label="学院"
                                             ItemValue="r => r.SchoolId"
                                             ItemText="r => r.SchoolName"
                                             RequiredMessage="请选择学院"
                                             HideDetails="@("auto")"
                                             Dense
                                             Outlined>
                                    </MSelect>
                                </MCol>
                            </MRow>
                        </MContainer>
                        <MRow Style="margin-top:1%;">
                            <MCol Cols="12"
                                  Sm="12">
                                <MTextarea TValue="string"
                                           TItemValue="string"
                                           @bind-Value="mTeacher.Description"
                                           Filled
                                           AutoGrow
                                           BackgroundColor="rgb(0,0,0,0)"
                                           Outlined
                                           Label="备注">
                                </MTextarea>
                            </MCol>
                        </MRow>
                    </MCardText>
                    <MCardActions>
                        <div style="position:absolute;bottom:3%;left:4%;font-weight:bold;color:rgba(192,192,192,55)">注：带*的为必填项</div>
                        <MSpacer></MSpacer>

                        <MButton Color="black"
                                 Text
                                 Outlined
                                 Type="submit">
                            保存
                        </MButton>
                        <MButton Color="black"
                                 Outlined
                                 Text
                                 OnClick="() => dialog = false">
                            取消
                        </MButton>

                        <MSpacer></MSpacer>
                    </MCardActions>
                </MForm>
            </MCard>
        </ChildContent>
    </MDialog>
</MRow>

<!--通用成功弹窗-->
<MDialog @bind-Value="completeVisiable"
         MaxWidth="300">
    <ChildContent>
        <MCard>
            <MCardTitle>
                信息新增成功
            </MCardTitle>
            <MCardActions>
                <MSpacer></MSpacer>
                <MButton Color="black"
                         Text
                         OnClick="() => {UpdateTeacherInfoInCache();completeVisiable = false;dialog=false;}">
                    确认
                </MButton>
            </MCardActions>
        </MCard>
    </ChildContent>
</MDialog>

<!--通用报错弹窗-->
<MDialog @bind-Value="_errorVisiable"
         MaxWidth="400"
         Persistent>
    <ChildContent>
        <MCard>
            <MCardTitle>
                温馨提示
            </MCardTitle>
            <MCardText>@_errorMessage</MCardText>
            <MCardActions>
                <MSpacer></MSpacer>
                <MButton Text
                         OnClick="() => {_errorMessage=null ;_errorVisiable = false;}">
                    确认
                </MButton>
            </MCardActions>
        </MCard>
    </ChildContent>
</MDialog>

<!--查看用选框-->
<MDialog @bind-Value="_readC"
         MaxWidth="900">
    <MCard>
        <MCardTitle>
            <span class="text-h5">教师信息</span>
        </MCardTitle>
        <MCardText>
            <MForm Model="mTeacher">
                <MContainer Style="border:solid 1px #82B1FF;padding-top:3;round-md;position:relative;">
                    <div style=" color: black; text-align: center; top: -13px; width: 110px; left: 3%; position: absolute; background: white;">基本信息</div>
                    <MRow>
                        <MCol Cols="12"
                              Sm="6"
                              Md="3">
                            <MTextField Label="姓名*"
                                        @bind-Value="mTeacher.Name"
                                        TValue="string"
                                        Readonly
                                        HideDetails="@("auto")"
                                        Dense
                                        Outlined>
                            </MTextField>
                        </MCol>
                        <MCol Cols="12"
                              Sm="6"
                              Md="3">
                            <MSelect @bind-Value="mTeacher.Sex"
                                     Items="@(Enum.GetNames(typeof(Sexs)).Select(name => name).ToList())"
                                     ItemText="r => r" ItemValue="r => r"
                                     Label="性别*"
                                     Readonly
                                     HideDetails="@("auto")"
                                     Dense
                                     Outlined></MSelect>

                        </MCol>
                        <MCol Cols="12"
                              Sm="6"
                              Md="6">
                            <MTextField Label="联系电话"
                                        Type="number"
                                        @bind-Value="mTeacher.PhoneNumber"
                                        TValue="string"
                                        Readonly
                                        NumberProps="@(prop => { prop.HideControl = true; })"
                                        HideDetails="@("auto")"
                                        Dense
                                        Outlined>
                            </MTextField>
                        </MCol>
                        <MCol Cols="12"
                              Sm="6"
                              Md="6">
                            <MTextField Label="身份证号*"
                                        @bind-Value="mTeacher.IdNumber"
                                        TValue="string"
                                        Readonly
                                        HideDetails="@("auto")"
                                        Dense
                                        Outlined>
                            </MTextField>
                        </MCol>
                        <MCol Cols="12"
                              Sm="6"
                              Md="6">
                            <MTextField Label="联系邮箱"
                                        @bind-Value="mTeacher.Email"
                                        TValue="string"
                                        Readonly
                                        HideDetails="@("auto")"
                                        Dense
                                        Outlined></MTextField>
                        </MCol>
                    </MRow>
                </MContainer>

                <MContainer Style="margin-top:4%; border:solid 1px #82B1FF; position:relative;">
                    <div style=" color: black; text-align: center; top:-13px;width: 110px; left: 3%; position: absolute; background: white;">就职信息</div>
                    <MRow Style="margin-top:1%;">
                        <MCol Cols="12"
                              Sm="6"
                              Md="6">
                            <MTextField Label="教职工号*"
                                        @bind-Value="mTeacher.EmployeeID"
                                        TValue="string"
                                        Readonly
                                        NumberProps="@(prop => { prop.HideControl = true; })"
                                        HideDetails="@("auto")"
                                        Dense
                                        Outlined>
                            </MTextField>
                        </MCol>
                        <MCol Cols="12"
                              Sm="3"
                              Md="3">
                            <MSpacer></MSpacer>
                            @if (_enrollmentDate == DateOnly.MinValue)
                            {
                                <MTextField Label="入职日期"
                                            TValue="string"
                                            Value="@("yyyy-mm-dd")"
                                            Dense
                                            HideDetails="@("auto")"
                                            Readonly
                                            AppendIcon="mdi-calendar-range">
                                </MTextField>
                            }
                            else
                            {
                                <MTextField Label="入职日期"
                                            TValue="DateOnly"
                                            ValidateOnBlur
                                            Dense
                                            HideDetails="@("auto")"
                                            @bind-Value="_enrollmentDate"
                                            Readonly
                                            AppendIcon="mdi-calendar-range">
                                </MTextField>
                            }
                        </MCol>
                        <MCol Cols="12"
                              Sm="3"
                              Md="3">
                            @if (_expiryDate == DateOnly.MinValue)
                            {
                                <MTextField Label="合同到期日期"
                                            TValue="string"
                                            Value="@("yyyy-mm-dd")"
                                            Dense
                                            HideDetails="@("auto")"
                                            Readonly
                                            AppendIcon="mdi-calendar-range">
                                </MTextField>
                            }
                            else
                            {
                                <MTextField Label="合同到期日期"
                                            TValue="DateOnly"
                                            ValidateOnBlur
                                            Dense
                                            HideDetails="@("auto")"
                                            @bind-Value="_expiryDate"
                                            Readonly
                                            AppendIcon="mdi-calendar-range">
                                </MTextField>
                            }
                        </MCol>
                        <MCol Cols="12"
                              Sm="6"
                              Md="3">
                            <MSelect @bind-Value="mTeacher.IsBudgetedPosts"
                                     Items="@(Enum.GetNames(typeof(YesNo)).Select(name => name).ToList())"
                                     ItemText="r => r.ToString()"
                                     ItemValue="r => r.Equals(yes)?true:false"
                                     Label="是否有编制*"
                                     Readonly
                                     Dense
                                     HideDetails="@("auto")"
                                     Outlined></MSelect>
                        </MCol>
                        <MCol Cols="12"
                              Sm="6"
                              Md="3">
                            <MTextField TValue="string"
                                        @bind-Value="mTeacher.JobTitle"
                                        Label="职称"
                                        Readonly
                                        HideDetails="@("auto")"
                                        Dense
                                        Outlined>
                            </MTextField>
                        </MCol>
                        <MCol Cols="12"
                              Sm="6"
                              Md="3">
                            <MTextField TValue="string"
                                        @bind-Value="mTeacher.JobPosition"
                                        Label="职务"
                                        Dense
                                        Readonly
                                        HideDetails="@("auto")"
                                        Outlined>
                            </MTextField>
                        </MCol>
                        <MCol Cols="12"
                              Sm="6"
                              Md="3">
                            <MTextField TValue="string"
                                        @bind-Value="mTeacher.SchoolName"
                                        Label="学院"
                                        Readonly
                                        HideDetails="@("auto")"
                                        Dense
                                        Outlined>
                            </MTextField>
                        </MCol>


                    </MRow>
                </MContainer>
                <MRow Style="margin-top:1%;">
                    <MCol Cols="12"
                          Sm="12">
                        <MTextarea TValue="string"
                                   TItemValue="string"
                                   @bind-Value="mTeacher.Description"
                                   Filled
                                   AutoGrow
                                   Readonly
                                   BackgroundColor="rgb(0,0,0,0)"
                                   Outlined
                                   Label="备注">
                        </MTextarea>
                    </MCol>
                </MRow>
                <MCardActions>
                    <MSpacer></MSpacer>
                    <MButton Outlined
                             Text
                             OnClick="() => _readC = false">
                        关闭
                    </MButton>
                    <MSpacer></MSpacer>
                </MCardActions>


            </MForm>
        </MCardText>
    </MCard>
</MDialog>

<!--编辑用选框-->
<MDialog @bind-Value="_editC"
         MaxWidth="900">
    <MCard>
        <MCardTitle>
            <span class="text-h5">编辑教师信息</span>
        </MCardTitle>

        <MCardText>

            <MForm Model="mTeacher" @bind-Value="_editValid" OnValidSubmit="UpdateTeacherInfo">
                <MContainer Style="border:solid 1px #82B1FF;padding-top:3;round-md;position:relative;">
                    <div style=" color: black; text-align: center; top: -13px; width: 110px; left: 3%; position: absolute; background: white;">基本信息</div>
                    <MRow>
                        <MCol Cols="12"
                              Sm="6"
                              Md="3">
                            <MTextField Label="姓名*"
                                        @bind-Value="mTeacher.Name"
                                        TValue="string"
                                        Autofocus
                                        Required
                                        RequiredMessage="请输入教师姓名"
                                        HideDetails="@("auto")"
                                        Dense
                                        Outlined>
                            </MTextField>
                        </MCol>
                        <MCol Cols="12"
                              Sm="6"
                              Md="3">
                            <MSelect @bind-Value="mTeacher.Sex"
                                     Items="@(Enum.GetNames(typeof(Sexs)).Select(name => name).ToList())"
                                     ItemText="r => r" ItemValue="r => r"
                                     Label="性别*"
                                     SingleLine
                                     Required
                                     RequiredMessage="请选择性别"
                                     HideDetails="@("auto")"
                                     Dense
                                     Outlined></MSelect>

                        </MCol>
                        <MCol Cols="12"
                              Sm="6"
                              Md="6">
                            <MTextField Label="联系电话"
                                        Type="number"
                                        @bind-Value="mTeacher.PhoneNumber"
                                        TValue="string"
                                        Rules="Command.PhoneRule"
                                        NumberProps="@(prop => { prop.HideControl = true; })"
                                        HideDetails="@("auto")"
                                        Dense
                                        Outlined>
                            </MTextField>
                        </MCol>
                        <MCol Cols="12"
                              Sm="6"
                              Md="6">
                            <MTextField Label="身份证号*"
                                        @bind-Value="mTeacher.IdNumber"
                                        TValue="string"
                                        RequiredMessage="请输入身份证号"
                                        Required
                                        Rules="Command.IDRule"
                                        HideDetails="@("auto")"
                                        Dense
                                        Outlined>
                            </MTextField>
                        </MCol>
                        <MCol Cols="12"
                              Sm="6"
                              Md="6">
                            <MTextField Label="联系邮箱"
                                        @bind-Value="mTeacher.Email"
                                        TValue="string"
                                        Rules="Command.MailRule"
                                        PersistentHint
                                        HideDetails="@("auto")"
                                        Dense
                                        Outlined></MTextField>
                        </MCol>
                    </MRow>
                </MContainer>

                <MContainer Style="margin-top:4%; border:solid 1px #82B1FF; position:relative;">
                    <div style=" color: black; text-align: center; top:-13px;width: 110px; left: 3%; position: absolute; background: white;">就职信息</div>
                    <MRow Style="margin-top:1%;">
                        <MCol Cols="12"
                              Sm="6"
                              Md="6">
                            <MTextField Label="教职工号*"
                                        @bind-Value="mTeacher.EmployeeID"
                                        TValue="string"
                                        Rules="Command.EmpIDRule"
                                        NumberProps="@(prop => { prop.HideControl = true; })"
                                        HideDetails="@("auto")"
                                        Dense
                                        Required
                                        Outlined>
                            </MTextField>
                        </MCol>
                        <MCol Cols="12"
                              Sm="3"
                              Md="3">
                            <MSpacer></MSpacer>
                            @if (_enrollmentDate == DateOnly.MinValue)
                            {
                                <MTextField Label="入职日期"
                                            TValue="string"
                                            Value="@("yyyy-mm-dd")"
                                            Dense
                                            HideDetails="@("auto")"
                                            Readonly
                                            AppendIcon="mdi-calendar-range"
                                            OnMouseUp="() => _enrollC = true"
                                            OnAppendClick="() => _enrollC = true">
                                </MTextField>
                            }
                            else
                            {
                                <MTextField Label="入职日期"
                                            TValue="DateOnly"
                                            Dense
                                            HideDetails="@("auto")"
                                            @bind-Value="_enrollmentDate"
                                            Readonly
                                            AppendIcon="mdi-calendar-range"
                                            OnMouseUp="() => _enrollC = true"
                                            OnAppendClick="() => _enrollC = true">
                                </MTextField>
                            }
                        </MCol>
                        <MCol Cols="12"
                              Sm="3"
                              Md="3">
                            @if (_expiryDate == DateOnly.MinValue)
                            {
                                <MTextField Label="合同到期日期"
                                            TValue="string"
                                            Value="@("yyyy-mm-dd")"
                                            Dense
                                            HideDetails="@("auto")"
                                            Readonly
                                            AppendIcon="mdi-calendar-range"
                                            OnMouseUp="() => _expiryC = true"
                                            OnAppendClick="() => _expiryC = true">
                                </MTextField>
                            }
                            else
                            {
                                <MTextField Label="合同到期日期"
                                            TValue="DateOnly"
                                            Dense
                                            HideDetails="@("auto")"
                                            @bind-Value="_expiryDate"
                                            Readonly
                                            AppendIcon="mdi-calendar-range"
                                            OnMouseUp="() => _expiryC = true"
                                            OnAppendClick="() => _expiryC = true">
                                </MTextField>
                            }
                        </MCol>
                        <MCol Cols="12"
                              Sm="6"
                              Md="3">
                            <MSelect @bind-Value="mTeacher.IsBudgetedPosts"
                                     Items="@(Enum.GetNames(typeof(YesNo)).Select(name => name).ToList())"
                                     ItemText="r => r.ToString()"
                                     ItemValue="r => r.Equals(yes)?true:false"
                                     Label="是否有编制*"
                                     Required
                                     RequiredMessage="请选择是否有编制"
                                     Dense
                                     HideDetails="@("auto")"
                                     Outlined></MSelect>
                        </MCol>
                        <MCol Cols="12"
                              Sm="6"
                              Md="3">
                            <MSelect TItem="MData"
                                     TValue="string"
                                     TItemValue="string"
                                     Items="_jobTitleItems"
                                     @bind-Value="mTeacher.JobTitle"
                                     Label="职称"
                                     ItemValue="r => r.Name"
                                     ItemText="r => r.Name"
                                     RequiredMessage="请选择职称"
                                     HideDetails="@("auto")"
                                     Dense
                                     Outlined>
                            </MSelect>
                        </MCol>
                        <MCol Cols="12"
                              Sm="6"
                              Md="3">
                            <MTextField TValue="string"
                                        @bind-Value="mTeacher.JobPosition"
                                        Label="职务"
                                        RequiredMessage="请输入职务*"
                                        Dense
                                        HideDetails="@("auto")"
                                        Outlined>
                            </MTextField>
                        </MCol>
                        <MCol Cols="12"
                              Sm="6"
                              Md="3">
                            <MSelect Items="_allSchools"
                                     TItem="MSchool"
                                     TItemValue="int"
                                     TValue="int"
                                     @bind-Value="mTeacher.SchoolId"
                                     Label="学院"
                                     ItemValue="r => r.SchoolId"
                                     ItemText="r => r.SchoolName"
                                     RequiredMessage="请选择学院"
                                     HideDetails="@("auto")"
                                     Dense
                                     Outlined>
                            </MSelect>
                        </MCol>


                    </MRow>
                </MContainer>
                <MRow Style="margin-top:1%;">
                    <MCol Cols="12"
                          Sm="12">
                        <MTextarea TValue="string"
                                   TItemValue="string"
                                   @bind-Value="mTeacher.Description"
                                   Filled
                                   AutoGrow
                                   BackgroundColor="rgb(0,0,0,0)"
                                   Outlined
                                   Label="备注">
                        </MTextarea>
                    </MCol>
                </MRow>
                <MCardActions>
                    <div style="position:absolute;bottom:6%;left:4%;font-weight:bold;color:rgba(192,192,192,55)">注：带*的为必填项</div>
                    <MSpacer></MSpacer>

                    <MButton Color="black"
                             Text
                             Outlined
                             Type="submit">
                        保存
                    </MButton>
                    <MButton Color="black"
                             Outlined
                             Text
                             OnClick="() => _editC = false">
                        取消
                    </MButton>
                    <MSpacer></MSpacer>
                </MCardActions>
            </MForm>
            <MDialog @bind-Value="_editCompleteVisiable"
                     MaxWidth="400">
                <ChildContent>
                    <MCard>
                        <MCardTitle>
                            信息修改成功
                        </MCardTitle>
                        <MCardActions>
                            <MSpacer></MSpacer>
                            <MButton Color="black"
                                     Text
                                     OnClick="()=> {UpdateTeacherInfoInCache(); _editCompleteVisiable = false; _editC = false; }">
                                确认
                            </MButton>
                        </MCardActions>
                    </MCard>
                </ChildContent>
            </MDialog>

        </MCardText>
    </MCard>
</MDialog>

<!--离职用选框-->
<MDialog @bind-Value="_resignC" MaxWidth="600">
    <MCard>
        <MForm Model="mTeacher" @bind-Value="_resignValid" OnValidSubmit="ResignTeacherSubmit">
            <MCardTitle Class="text-h5">为 @mTeacher.Name 办理离职</MCardTitle>
            <MCardText>
                <MContainer Style="border:solid 1px #82B1FF;padding-top:3;round-md;position:relative;">
                    <div style=" color: black; text-align: center; top: -13px; width: 110px; left: 3%; position: absolute; background: white;">基本信息</div>
                    <MRow Style="margin-top:3;">
                        <MCol Cols="12"
                              Sm="6"
                              Md="6"
                              Style="margin-top:4%;">
                            <MTextField Label="教职工号"
                                        TValue="string"
                                        Dense
                                        HideDetails="@("auto")"
                                        @bind-Value="mTeacher.EmployeeID"
                                        Outlined
                                        Readonly>
                            </MTextField>
                        </MCol>
                        <MCol Cols="12"
                              Sm="6"
                              Md="6"
                              Style="margin-top:4%;">
                            <MTextField Label="姓名"
                                        TValue="string"
                                        Dense
                                        HideDetails="@("auto")"
                                        @bind-Value="mTeacher.Name"
                                        Outlined
                                        Readonly>
                            </MTextField>
                        </MCol>
                        <MCol Cols="12"
                              Sm="6"
                              Md="6">
                            <MSpacer></MSpacer>
                            @if (_enrollmentDate == DateOnly.MinValue)
                            {
                                <MTextField Label="入职日期"
                                            TValue="string"
                                            Value="@("yyyy-mm-dd")"
                                            Dense
                                            HideDetails="@("auto")"
                                            Readonly
                                            AppendIcon="mdi-calendar-range">
                                </MTextField>
                            }
                            else
                            {
                                <MTextField Label="入职日期"
                                            TValue="DateOnly"
                                            Dense
                                            HideDetails="@("auto")"
                                            @bind-Value="_enrollmentDate"
                                            Readonly
                                            AppendIcon="mdi-calendar-range">
                                </MTextField>
                            }
                        </MCol>
                        <MCol Cols="12"
                              Sm="6"
                              Md="6">
                            @if (_expiryDate == DateOnly.MinValue)
                            {
                                <MTextField Label="合同到期日期"
                                            TValue="string"
                                            Value="@("yyyy-mm-dd")"
                                            Dense
                                            HideDetails="@("auto")"
                                            Readonly
                                            AppendIcon="mdi-calendar-range">
                                </MTextField>
                            }
                            else
                            {
                                <MTextField Label="合同到期日期"
                                            TValue="DateOnly"
                                            Dense
                                            HideDetails="@("auto")"
                                            @bind-Value="_expiryDate"
                                            Readonly
                                            AppendIcon="mdi-calendar-range">
                                </MTextField>
                            }
                        </MCol>
                    </MRow>
                </MContainer>
                <MContainer Style="margin-top:4%; border:solid 1px #82B1FF; position:relative;">
                    <div style=" color: black; text-align: center; top:-13px;width: 110px; left: 3%; position: absolute; background: white;">离职信息</div>
                    <MRow>
                        <MCol Cols="12"
                              Sm="6"
                              Md="6"
                              Style="margin-top:4%;">
                            @if (_resignDate == DateOnly.MinValue)
                            {
                                <MTextField Label="离职日期*"
                                            TValue="string"
                                            Value="@("yyyy-mm-dd")"
                                            Dense
                                            HideDetails="@("auto")"
                                            Readonly
                                            AppendIcon="mdi-calendar-range"
                                            OnMouseUp="() => _resignDateC=true"
                                            OnAppendClick="() => _resignDateC=true">
                                </MTextField>
                            }
                            else
                            {
                                <MTextField Label="离职日期*"
                                            TValue="DateOnly"
                                            Dense
                                            HideDetails="@("auto")"
                                            @bind-Value="_resignDate"
                                            Readonly
                                            AppendIcon="mdi-calendar-range"
                                            OnMouseUp="() => _resignDateC=true"
                                            OnAppendClick="() => _resignDateC=true">
                                </MTextField>
                            }
                        </MCol>
                        <MCol Cols="12"
                              Sm="12"
                              Md="12"
                              Style="mb-0;pb-0">
                            <MTextarea TValue="string"
                                       TItemValue="string"
                                       @bind-Value="mTeacher.DepartedReason"
                                       Filled
                                       Required
                                       Outlined
                                       BackgroundColor="rgba(0,0,0,0)"
                                       RequiredMessage="请输入教师离职原因"
                                       HideDetails="@("auto")"
                                       Label="离职原因*">
                            </MTextarea>
                        </MCol>
                    </MRow>
                </MContainer>
                <MRow Style="margin-top:1%;">
                    <MCol Cols="12"
                          Sm="12"
                          Md="12"
                          Style="mt-0;pt-0">
                        <MTextarea TValue="string"
                                   TItemValue="string"
                                   Style="mt-1"
                                   @bind-Value="mTeacher.Description"
                                   Filled
                                   HideDetails="@("auto")"
                                   AutoGrow
                                   BackgroundColor="rgb(0,0,0,0)"
                                   Outlined
                                   Label="备注">
                        </MTextarea>
                    </MCol>
                </MRow>

                <MDialog @bind-Value="_resignCompleteVisiable"
                         MaxWidth="400">
                    <ChildContent>
                        <MCard>
                            <MCardTitle>
                                办理成功
                            </MCardTitle>
                            <MCardActions>
                                <MSpacer></MSpacer>
                                <MButton Color="black"
                                         Text
                                         OnClick="() => { UpdateTeacherInfoInCache(); _resignCompleteVisiable = false; _resignC = false; }">
                                    确认
                                </MButton>
                            </MCardActions>
                        </MCard>
                    </ChildContent>
                </MDialog>
            </MCardText>
            <MCardActions>
                <div style="position:absolute;bottom:2%;left:4%;font-weight:bold;color:rgba(192,192,192,55)">注：带*的为必填项</div>
                <MSpacer></MSpacer>
                <MButton Color="black"
                         Text
                         Outlined
                         Disabled="!_resignValid"
                         Type="submit">
                    保存
                </MButton>
                <MButton Color="black"
                         Outlined
                         Text
                         OnClick="() => _resignC = false">
                    取消
                </MButton>
                <MSpacer></MSpacer>
            </MCardActions>
        </MForm>
    </MCard>
</MDialog>

<!--批量离职办理用选框-->
<MDialog @bind-Value="_groupResignC" MaxWidth="500">
    <MCard>
        <MCardTitle Class="text-h5">批量办理离职</MCardTitle>
        <MCardText>
            <MContainer Style="border:solid 1px #82B1FF;padding-top:3;round-md;position:relative;">
                <div style=" color: black; text-align: center; top: -13px; width: 110px; left: 3%; position: absolute; background: white;">基本信息</div>
                <MRow Style="margin-top:2%;">
                    <MCol Cols="12"
                          Sm="6"
                          Md="6">
                        <MMenu OpenOnHover OffsetY>
                            <ActivatorContent>
                                <MButton @attributes="@context.Attrs">名称列表</MButton>
                            </ActivatorContent>
                            <ChildContent>
                                <MList>
                                    @foreach (var item in _selected.ToList())
                                    {
                                        <MListItem>
                                            <MListItemContent>
                                                <MListItemTitle>
                                                    @item.Name
                                                </MListItemTitle>
                                            </MListItemContent>
                                        </MListItem>
                                    }
                                </MList>
                            </ChildContent>
                        </MMenu>
                    </MCol>
                    <MCol Cols="12"
                          Sm="6"
                          Md="6">
                        <MMenu OpenOnHover OffsetY>
                            <ActivatorContent>
                                <MButton @attributes="@context.Attrs">职工号列表</MButton>
                            </ActivatorContent>
                            <ChildContent>
                                <MList>
                                    @foreach (var item in _selected.ToList())
                                    {
                                        <MListItem>
                                            <MListItemContent>
                                                <MListItemTitle>
                                                    @item.TeacherId
                                                </MListItemTitle>
                                            </MListItemContent>
                                        </MListItem>
                                    }
                                </MList>
                            </ChildContent>
                        </MMenu>
                    </MCol>
                </MRow>
            </MContainer>
            <MForm Model="_selected" @bind-Value="_groupResignValid" OnValidSubmit="GroupResignTeacherSubmit">
                <MContainer Style="margin-top:4%; border:solid 1px #82B1FF; position:relative;">
                    <div style=" color: black; text-align: center; top:-13px;width: 110px; left: 3%; position: absolute; background: white;">离职信息</div>
                    <MRow>
                        <MCol Cols="12"
                              Sm="6"
                              Md="6"
                              Style="margin-top:4%;">
                            <MTextField Label="离职日期*"
                                        TValue="DateOnly"
                                        Dense
                                        HideDetails="@("auto")"
                                        @bind-Value="_resignDate"
                                        Readonly
                                        AppendIcon="mdi-calendar-range"
                                        OnMouseUp="() => _resignDateC=true"
                                        OnAppendClick="() => _resignDateC=true">
                            </MTextField>
                        </MCol>

                        <MCol Cols="12"
                              Sm="12"
                              Md="12"
                              Style="mb-0;pb-0">
                            <MTextarea TValue="string"
                                       TItemValue="string"
                                       @bind-Value="_groupResignReason"
                                       Filled
                                       Required
                                       Outlined
                                       BackgroundColor="rgba(0,0,0,0)"
                                       RequiredMessage="请输入教师离职原因"
                                       HideDetails="@("auto")"
                                       Label="离职原因*">
                            </MTextarea>
                        </MCol>
                    </MRow>
                </MContainer>
                <MRow Style="margin-top:1%;">
                    <MCol Cols="12"
                          Sm="12"
                          Md="12"
                          Style="mt-0;pt-0">
                        <MTextarea TValue="string"
                                   TItemValue="string"
                                   Style="mt-1"
                                   @bind-Value="_groupDescription"
                                   Filled
                                   HideDetails="@("auto")"
                                   AutoGrow
                                   BackgroundColor="rgb(0,0,0,0)"
                                   Outlined
                                   Label="备注【注意：会添加到选中所有教师的备注！！】">
                        </MTextarea>
                    </MCol>
                </MRow>
                <MCardActions>
                    <div style="position:absolute;bottom:6%;left:4%;font-weight:bold;color:rgba(192,192,192,55)">注：带*的为必填项</div>
                    <MSpacer></MSpacer>
                    <MButton Color="black"
                             Text
                             Outlined
                             Disabled="!_groupResignValid"
                             Type="submit">
                        确认
                    </MButton>
                    <MButton Color="black"
                             Outlined
                             Text
                             OnClick="() => _groupResignC = false">
                        取消
                    </MButton>
                    <MSpacer></MSpacer>
                </MCardActions>
            </MForm>
        </MCardText>
        <MDialog @bind-Value="_resignCompleteVisiable"
                 MaxWidth="400">
            <ChildContent>
                <MCard>
                    <MCardTitle>
                        办理成功
                    </MCardTitle>
                    <MCardActions>
                        <MSpacer></MSpacer>
                        <MButton Color="black"
                                 Text
                                 OnClick="() => { UpdateTeacherInfoInCache();_selected=new List<MTeacher>();  _resignCompleteVisiable = false; _groupResignC = false; }">
                            确认
                        </MButton>
                    </MCardActions>
                </MCard>
            </ChildContent>
        </MDialog>


    </MCard>
</MDialog>

<!--归档用选框-->
<MDialog @bind-Value="_deleteTeacherC" MaxWidth="500">
    <MCard>
        <MCardTitle Class="text-h5">你确定要归档该条教师信息：@mTeacher.Name ?</MCardTitle>
        <MCardText>
            <MContainer Style="border:solid 1px #82B1FF;padding-top:3;round-md;position:relative;">
                <div style=" color: black; text-align: center; top: -13px; width: 110px; left: 3%; position: absolute; background: white;">基本信息</div>
                <MRow Style="margin-top:3;">
                    <MCol Cols="12"
                          Sm="6"
                          Md="6"
                          Style="margin-top:4%;">
                        <MTextField Label="教职工号"
                                    TValue="string"
                                    Dense
                                    Outlined
                                    HideDetails="@("auto")"
                                    @bind-Value="mTeacher.EmployeeID"
                                    Readonly>
                        </MTextField>
                    </MCol>
                    <MCol Cols="12"
                          Sm="6"
                          Md="6"
                          Style="margin-top:4%;">
                        <MTextField Label="姓名"
                                    TValue="string"
                                    Dense
                                    HideDetails="@("auto")"
                                    @bind-Value="mTeacher.Name"
                                    Outlined
                                    Readonly>
                        </MTextField>
                    </MCol>
                    <MCol Cols="12"
                          Sm="6"
                          Md="6">
                        <MSpacer></MSpacer>
                        @if (_enrollmentDate == DateOnly.MinValue)
                        {
                            <MTextField Label="入职日期"
                                        TValue="string"
                                        Value="@("yyyy-mm-dd")"
                                        Dense
                                        HideDetails="@("auto")"
                                        Readonly
                                        AppendIcon="mdi-calendar-range">
                            </MTextField>
                        }
                        else
                        {
                            <MTextField Label="入职日期"
                                        TValue="DateOnly"
                                        Dense
                                        HideDetails="@("auto")"
                                        @bind-Value="_enrollmentDate"
                                        Readonly
                                        AppendIcon="mdi-calendar-range">
                            </MTextField>
                        }
                    </MCol>
                    <MCol Cols="12"
                          Sm="6"
                          Md="6">
                        @if (_expiryDate == DateOnly.MinValue)
                        {
                            <MTextField Label="合同到期日期"
                                        TValue="string"
                                        Value="@("yyyy-mm-dd")"
                                        Dense
                                        HideDetails="@("auto")"
                                        Readonly
                                        AppendIcon="mdi-calendar-range">
                            </MTextField>
                        }
                        else
                        {
                            <MTextField Label="合同到期日期"
                                        TValue="DateOnly"
                                        Dense
                                        HideDetails="@("auto")"
                                        @bind-Value="_expiryDate"
                                        Readonly
                                        AppendIcon="mdi-calendar-range">
                            </MTextField>
                        }
                    </MCol>
                </MRow>
            </MContainer>
            <MForm Model="mTeacher" @bind-Value="_deleteTeacherValid" OnValidSubmit="DeleteConfirm">
                <MTextarea TValue="string"
                           TItemValue="string"
                           @bind-Value="mTeacher.DeleteReason"
                           Filled
                           Required
                           BackgroundColor="rgb(0,0,0,0)"
                           Outlined
                           Style="margin-top:2%;"
                           HideDetails="@("auto")"
                           Label="归档原因*">
                </MTextarea>
                <MTextarea TValue="string"
                           TItemValue="string"
                           @bind-Value="mTeacher.Description"
                           Style="margin-top:2%;"
                           Filled
                           AutoGrow
                           BackgroundColor="rgb(0,0,0,0)"
                           Outlined
                           Label="备注">
                </MTextarea>
                <MCardActions>
                    <div style="position:absolute;bottom:5%;left:4%;font-weight:bold;color:rgba(192,192,192,55)">注：带*的为必填项</div>
                    <MSpacer></MSpacer>

                    <MButton Text
                             Outlined
                             Disabled="@(_deleteButtonTime!=0||!_deleteTeacherValid)"
                             Type="submit">
                        @(_deleteButtonTime == 0 ? "确认" : "确认(" + $" {_deleteButtonTime} 秒)")
                    </MButton>
                    <MButton Color="black"
                             Outlined
                             Text
                             OnClick="() => _deleteTeacherC = false">
                        取消
                    </MButton>
                    <MSpacer></MSpacer>
                </MCardActions>
            </MForm>
        </MCardText>
        <MDialog @bind-Value="_deleteTeacherCompleteVisiable"
                 MaxWidth="400">
            <ChildContent>
                <MCard>
                    <MCardTitle>
                        归档成功
                    </MCardTitle>
                    <MCardActions>
                        <MSpacer></MSpacer>
                        <MButton Text
                                 OnClick="() => { UpdateTeacherInfoInCache(); _deleteTeacherCompleteVisiable = false; _deleteTeacherC = false; }">
                            确认
                        </MButton>
                    </MCardActions>
                </MCard>
            </ChildContent>
        </MDialog>
    </MCard>
</MDialog>

<!--批量归档用选框-->
<MDialog @bind-Value="_DeleteGroupC" MaxWidth="500">
    <MCard>
        <MCardTitle Class="text-h5">批量归档教师信息</MCardTitle>
        <MCardText>
            <MContainer Style="border:solid 1px #82B1FF;padding-top:3;round-md;position:relative;">
                <div style=" color: black; text-align: center; top: -13px; width: 110px; left: 3%; position: absolute; background: white;">基本信息</div>
                <MRow Style="margin-top:2%;">

                    <MCol Cols="12"
                          Sm="6"
                          Md="6">
                        <MMenu OpenOnHover OffsetY>
                            <ActivatorContent>
                                <MButton @attributes="@context.Attrs">名称列表</MButton>
                            </ActivatorContent>
                            <ChildContent>
                                <MList>
                                    @foreach (var item in _selected.ToList())
                                    {
                                        <MListItem>
                                            <MListItemContent>
                                                <MListItemTitle>
                                                    @item.Name
                                                </MListItemTitle>
                                            </MListItemContent>
                                        </MListItem>
                                    }
                                </MList>
                            </ChildContent>
                        </MMenu>
                    </MCol>
                    <MCol Cols="12"
                          Sm="6"
                          Md="6">
                        <MMenu OpenOnHover OffsetY>
                            <ActivatorContent>
                                <MButton @attributes="@context.Attrs">职工号列表</MButton>
                            </ActivatorContent>
                            <ChildContent>
                                <MList>
                                    @foreach (var item in _selected.ToList())
                                    {
                                        <MListItem>
                                            <MListItemContent>
                                                <MListItemTitle>
                                                    @item.TeacherId
                                                </MListItemTitle>
                                            </MListItemContent>
                                        </MListItem>
                                    }
                                </MList>
                            </ChildContent>
                        </MMenu>
                    </MCol>
                </MRow>
            </MContainer>
            <MForm Model="_selected" @bind-Value="_deleteTeacherValid" OnValidSubmit="GroupDeleteConfirm">
                <MTextarea TValue="string"
                           TItemValue="string"
                           @bind-Value="_deleteReason"
                           Style="margin-top:2%;"
                           Filled
                           Required
                           Outlined
                           BackgroundColor="rgb(0,0,0,0)"
                           HideDetails="@("auto")"
                           Label="归档原因*">
                </MTextarea>
                <MTextarea TValue="string"
                           TItemValue="string"
                           @bind-Value="_deleteDescription"
                           Filled
                           AutoGrow
                           BackgroundColor="rgb(0,0,0,0)"
                           Style="margin-top:2%;"
                           Outlined
                           Label="备注【注意：会添加到所有选中教师的备注！！】">
                </MTextarea>




                <MCardActions>
                    <div style="position:absolute;bottom:3%;left:4%;font-weight:bold;color:rgba(192,192,192,55)">注：带*的为必填项</div>
                    <MSpacer></MSpacer>

                    <MButton Text
                             Outlined
                             Disabled="@(_deleteButtonTime!=0||!_deleteTeacherValid)"
                             Type="submit">
                        @(_deleteButtonTime == 0 ? "确认" : "确认(" + $" {_deleteButtonTime} 秒)")
                    </MButton>
                    <MButton Outlined
                             Text
                             OnClick="() => _DeleteGroupC = false">
                        取消
                    </MButton>
                    <MSpacer></MSpacer>
                </MCardActions>
            </MForm>
        </MCardText>
        <MDialog @bind-Value="_deleteGroupCompleteVisiable"
                 MaxWidth="400">
            <ChildContent>
                <MCard>
                    <MCardTitle>
                        归档成功
                    </MCardTitle>
                    <MCardActions>
                        <MSpacer></MSpacer>
                        <MButton Text
                                 OnClick="() => { UpdateTeacherInfoInCache(); _selected=new List<MTeacher>();_deleteGroupCompleteVisiable = false; _DeleteGroupC = false; }">
                            <MIcon>mdi-check</MIcon>确认
                        </MButton>
                    </MCardActions>
                </MCard>
            </ChildContent>
        </MDialog>
    </MCard>
</MDialog>

<!--入职日期选框-->
<MDialog @bind-Value="_enrollC" Width="375" Style="height:fit-content">
    <MDatePicker @bind-Value="_enrollmentDate"
                 Elevation="15"
                 FullWidth
                 Scrollable
                 Locale="zh-Hans"
                 OnDateClick="() => {
                    _enrollC=false;
                    mTeacher.EnrollmentDate = _enrollmentDate.ToDateTime(TimeOnly.MinValue);}">
    </MDatePicker>
</MDialog>

<!--合同到期日期选框-->
<MDialog @bind-Value="_expiryC"
         Width="375"
         Style="height:fit-content">
    <MDatePicker @bind-Value="_expiryDate"
                 Elevation="15"
                 FullWidth
                 Scrollable
                 Locale="zh-Hans"
                 OnDateClick="() =>
                {
                _expiryC=false;
                mTeacher.ExpiryDate = _expiryDate.ToDateTime(TimeOnly.MinValue);
                }"></MDatePicker>
</MDialog>

<!--离职日期选框-->
<MDialog @bind-Value="_resignDateC"
         Width="375"
         Style="height:fit-content">
    <MDatePicker @bind-Value="_resignDate"
                 Elevation="15"
                 FullWidth
                 Scrollable
                 Locale="zh-Hans"
                 OnDateClick="() =>
                {
                _resignDateC=false;
                mTeacher.DepartedDate = _resignDate.ToDateTime(TimeOnly.MinValue);
                }"></MDatePicker>
</MDialog>


@code {
    /*------------------------------------存储变量------------------------------------*/
    const string yes = "是";
    const string no = "否";
    /// <summary>
    /// 教师操作用选取
    /// </summary>
    private IEnumerable<MTeacher> _selected = new List<MTeacher>();
    /// <summary>
    /// 讲台操作用选取
    /// </summary>
    private IEnumerable<MTeachingClass> _selectedTeachingClass = new List<MTeachingClass>();
    /// <summary>
    /// 课程页面用选取
    /// </summary>
    private MTeacher _selectedTeacher = null;

    /// <summary>
    /// 所有教师信息
    /// </summary>
    private List<MTeacher> _teacherInfo;

    /// <summary>
    /// 所有学院信息
    /// </summary>
    private List<MSchool> _allSchools;

    /// <summary>
    /// 展示的教师信息
    /// </summary>
    private List<MTeacher> showTeachers = new List<MTeacher>();

    /// <summary>
    /// 所有教学班信息
    /// </summary>
    private Dictionary<string, List<MTeachingClass>> _teachingClasses = new Dictionary<string, List<MTeachingClass>>();

    /// <summary>
    /// 展示的教学班信息
    /// </summary>
    private List<MTeachingClass> _showTeachingClass = new List<MTeachingClass>();

    /// <summary>
    /// 职称
    /// </summary>
    public static List<MData> _jobTitleItems = DictService.GetJobTitles();
    /*------------------------------------启动------------------------------------*/

    /// <summary>
    /// 通用报错栏使用变量
    /// </summary>
    private string? _errorMessage = null;
    private bool _errorVisiable = false;

    /// <summary>
    /// 查看/更新缓存中教师信息
    /// </summary>
    /// <returns></returns>
    private List<MTeacher> LoadTeacherInfoFromCacheAsync()
    {
        const string cacheItemKey = "CachedInfo";

        if (!MemoryCache.TryGetValue(cacheItemKey, out List<MTeacher> cachedTeacherInfo))
        {
            cachedTeacherInfo = TeacherService.GetAllTeachers();

            var cacheEntryOptions = new MemoryCacheEntryOptions()
                .SetSlidingExpiration(TimeSpan.FromSeconds(30));

            MemoryCache.Set(cacheItemKey, cachedTeacherInfo, cacheEntryOptions);
        }
        _teacherInfo = cachedTeacherInfo;
        return cachedTeacherInfo;
    }

    /// <summary>
    /// 查看/更新缓存中学院信息
    /// </summary>
    /// <returns></returns>
    private List<MSchool> LoadSchoolInfoFromCacheAsync()
    {
        const string schoolCacheKey = "CachedSchoolInfo";

        if (!MemoryCache.TryGetValue(schoolCacheKey, out List<MSchool> cachedSchools))
        {
            cachedSchools = SchoolService.GetAllSchools();

            var cacheEntryOptions = new MemoryCacheEntryOptions()
                .SetSlidingExpiration(TimeSpan.FromMinutes(5));

            MemoryCache.Set(schoolCacheKey, cachedSchools, cacheEntryOptions);
        }
        _allSchools = cachedSchools;
        return cachedSchools;
    }

    /// <summary>
    /// 查看/更新缓存中教学班信息
    /// </summary>
    /// <returns></returns>
    private Dictionary<string, List<MTeachingClass>> LoadClassInfoFromCacheAsync()
    {
        const string cacheItemKey = "CachedClassGroupByTeacherInfo";

        if (!MemoryCache.TryGetValue(cacheItemKey, out Dictionary<string, List<MTeachingClass>> cachedClassInfo) || cachedClassInfo.Count == 0)
        {
            cachedClassInfo = TeachingClassService.GetAllTeachingClassGroupByTeacher();

            var cacheEntryOptions = new MemoryCacheEntryOptions()
                .SetSlidingExpiration(TimeSpan.FromSeconds(23));

            MemoryCache.Set(cacheItemKey, cachedClassInfo, cacheEntryOptions);

        }
        _teachingClasses = cachedClassInfo;
        return cachedClassInfo;
    }

    /// <summary>
    /// 启动时调用缓存中信息
    /// </summary>
    protected override void OnInitialized()
    {
        // 使用缓存中的数据
        LoadTeacherInfoFromCacheAsync();
        LoadSchoolInfoFromCacheAsync();
        LoadClassInfoFromCacheAsync();
        onSearch();
    }

    /// <summary>
    /// 更新缓存中的教师信息
    /// </summary>
    private void UpdateTeacherInfoInCache()
    {
        _teacherInfo = TeacherService.GetAllTeachers();

        // 更新缓存
        var cacheEntryOptions = new MemoryCacheEntryOptions()
            .SetSlidingExpiration(TimeSpan.FromSeconds(30));

        MemoryCache.Set("CachedInfo", _teacherInfo, cacheEntryOptions);
        onSearch();
        StateHasChanged();
        return;
    }

    /// <summary>
    /// 教师表格边界属性
    /// </summary>
    private DataTableResizeMode _resizeMode = DataTableResizeMode.Overflow;
    /// <summary>
    /// 教师信息表格
    /// </summary>
    private List<DataTableHeader<MTeacher>> _headers => new List<DataTableHeader<MTeacher>>
    {

    new()
        {
            Text = "  教职工号",
            Align = DataTableHeaderAlign.Center,
            Sortable = true,
            // Value =_headers.FindIndex(header => header.Value == nameof(MTeacher.TeacherId)),
            Value = nameof(MTeacher.EmployeeID),
            Ellipsis = new DataTableEllipsis(),
            Width = 140
        },
        new() {
            Text = "姓名",
            Value = nameof(MTeacher.Name),
            Align=DataTableHeaderAlign.Center,
            Class="text-no-wrap",
            Sortable=false,
            Ellipsis = new DataTableEllipsis(),
            Width=150
        },
        new() {
            Text = "性别",
            Value = nameof(MTeacher.Sex),
            Align=DataTableHeaderAlign.Center,
            Sortable=false,
            Width=65
        },
        new() { Text = "联系电话",
            Value = nameof(MTeacher.PhoneNumber),
            Align=DataTableHeaderAlign.Center,
            Ellipsis = new DataTableEllipsis(),
            Sortable=false,
            Width=200,
        },
        new() { Text = "联系邮箱",
            Value = nameof(MTeacher.Email),
            Align=DataTableHeaderAlign.Center,
            Sortable=false,
            Width=250
        },
        new() { Text = "学院",
            Value = nameof(MTeacher.SchoolName),
            Align=DataTableHeaderAlign.Center,
            Ellipsis = new DataTableEllipsis(),
            Sortable=false,
            Width=200,
        },
        new() { Text = "职务",
            Value = nameof(MTeacher.JobPosition),
            Align=DataTableHeaderAlign.Center,
            Ellipsis = new DataTableEllipsis(),
            Sortable=false,
            Class="text-no-wrap"
        },
        new() { Text = "职称",
            Value = nameof(MTeacher.JobTitle),
            Sortable=false,Align=DataTableHeaderAlign.Center,
            Ellipsis = new DataTableEllipsis(),
            Class="text-no-wrap"
        },
        new() {
            Text = "状态",
            Value="States",
            Sortable=false,
            Align=DataTableHeaderAlign.Center,
            Class="text-no-wrap"
        },
        new() {
            Text = "操作",
            Value = "Actions",
            Sortable = false,
            Align=DataTableHeaderAlign.Center,
            Width = 150
        }
    };

    /// <summary>
    /// 判断表格教师行是否可选
    /// </summary>
    /// <returns></returns>
    private Func<MTeacher, bool> TeacherSelectable()
    {
        return teacher =>
    {
        // 在这里定义教师选择逻辑
        return !teacher.IsDeleted && !teacher.IsDeparted;
    };
    }

    /*---------------------------------------导航栏--------------------------------------*/
    /// <summary>
    /// 导航标签页用变量
    /// </summary>
    private string page = "Teacher";

    /// <summary>
    /// 点击教师行时切换选取教师
    /// </summary>
    private void OnTeacherRowClick(DataTableRowMouseEventArgs<MTeacher> cour)
    {
        _selectedTeacher = cour.Item;
        _showTeachingClass = new List<MTeachingClass>();
        _selectedTeachingClass = new List<MTeachingClass>();
        foreach (var item in _teachingClasses)
        {
            if (item.Key.Equals(_selectedTeacher.EmployeeID))
            {
                _showTeachingClass = item.Value;
            }
        }
    }

    /*---------------------------------------操作栏--------------------------------------*/


    /*--------------------添加教师------------------------*/

    MTeacher mTeacher = null;
    // 表单填写检查
    private bool _valid = false;
    private bool completeVisiable = false;


    // 记录表单弹出/关闭
    private bool dialog = false;
    private bool _enrollC = false;
    private bool _expiryC = false;

    // 接收表格属性
    private DateOnly _enrollmentDate = DateOnly.MinValue;
    private DateOnly _expiryDate = DateOnly.MinValue;

    // 添加按钮点击事件，打开添加信息表单
    private void AddTeacherInfo()
    {
        mTeacher = new MTeacher();
        // mTeacher.EmployeeID = TeacherService.GetEmployeeID();
        dialog = true;
        mTeacher.EnrollmentDate = DateTime.MinValue;
        mTeacher.ExpiryDate = DateTime.MinValue;
        _enrollmentDate = DateOnly.MinValue;
        _expiryDate = DateOnly.MinValue;
    }

    /// <summary>
    /// 检查表单信息，有误则报错，无误则提交表单
    /// </summary>
    private void SubmitTeacherInfo()
    {
        // 入职日期和合同到期日期必须同时输入
        if (mTeacher.ExpiryDate != DateTime.MinValue && mTeacher.EnrollmentDate == DateTime.MinValue)
        {

            _errorMessage = "请输入入职日期！";
            _errorVisiable = true;
            return;
        }
        if (mTeacher.EnrollmentDate != DateTime.MinValue && mTeacher.ExpiryDate == DateTime.MinValue)
        {
            _errorMessage = "请输入合同到期日期！";
            _errorVisiable = true;
            return;
        }
        // EnrollmentDate is not earlier than ExpiryDate
        if (mTeacher.EnrollmentDate != DateTime.MinValue && mTeacher.ExpiryDate != DateTime.MinValue && mTeacher.EnrollmentDate >= mTeacher.ExpiryDate)
        {
            _errorMessage = "合同到期日期不能早于入职日期！";
            _errorVisiable = true;
            return;
        }
        _errorMessage = TeacherService.AddTeacherInfo(mTeacher);
        if (!string.IsNullOrEmpty(_errorMessage))
        {
            _errorVisiable = true;
            return;
        }
        completeVisiable = true;

        return;
    }


    /*----------------读取教师信息----------------*/
    private bool _readC = false;
    /// <summary>
    /// 打开读取教师信息表单
    /// </summary>
    /// <param name="teacher"></param>
    private void ReadTeacherForm(MTeacher teacher)
    {
        mTeacher = teacher;
        _readC = true;
        _enrollmentDate = DateOnly.FromDateTime(teacher.EnrollmentDate);
        _expiryDate = DateOnly.FromDateTime(teacher.ExpiryDate);
    }


    /*----------------归档教师信息----------------*/
    private bool _deleteTeacherC = false;
    private bool _deleteTeacherValid = false;
    private bool _deleteTeacherCompleteVisiable = false;
    private int _deleteButtonTime = 3;

    /// <summary>
    /// 存储按钮禁用时间的异步任务
    /// </summary>
    private Task _disableButtonTask;
    /// <summary>
    /// 控制按钮禁用时间异步任务
    /// </summary>
    private CancellationTokenSource _cancellationTokenSource;

    /// <summary>
    /// 归档窗口确认按钮限制
    /// </summary>
    /// <param name="token"></param>
    /// <returns></returns>
    private async Task DisableButtonTemporarily(CancellationToken token)
    {
        _deleteButtonTime = 3;
        StateHasChanged(); // 立即更新UI
        _deleteTeacherValid = false;
        for (; _deleteButtonTime > 0; _deleteButtonTime--)
        {
            StateHasChanged(); // 更新UI以显示剩余时间
            await Task.Delay(1000, token); // 等待1秒
        }
        _deleteTeacherValid = true;
        StateHasChanged(); // 更新UI以启用按钮
        _disableButtonTask = null;
    }

    /// <summary>
    /// 中断旧的倒计时任务并启动新的倒计时
    /// </summary>
    private void ActivateDisableButton()
    {
        if (_disableButtonTask != null && !_disableButtonTask.IsCompleted)
        {
            // 如果当前倒计时的异步任务未结束，取消它并重新启动
            _cancellationTokenSource.Cancel(); // 取消
            _disableButtonTask = null;
        }
        // 启动新任务
        _cancellationTokenSource = new CancellationTokenSource();
        _disableButtonTask = DisableButtonTemporarily(_cancellationTokenSource.Token);
    }

    /// <summary>
    /// 单人归档打开确认窗口
    /// </summary>
    /// <param name="teacher"></param>
    private void DeleteTeacherForm(MTeacher teacher)
    {
        mTeacher = CopyUtil<MTeacher, MTeacher>.Trans(teacher);
        _deleteButtonTime = 3;
        ActivateDisableButton();
        _deleteTeacherC = true;
        _deleteTeacherValid = false;
        _enrollmentDate = DateOnly.FromDateTime(mTeacher.EnrollmentDate);
        _expiryDate = DateOnly.FromDateTime(mTeacher.ExpiryDate);
    }

    // 单人归档确认提交
    private void DeleteConfirm()
    {
        List<MTeacher> list = new List<MTeacher> { mTeacher };
        _errorMessage = TeacherService.DeleteTeacher(list);
        if (!string.IsNullOrEmpty(_errorMessage)) _errorVisiable = true;
        else _deleteTeacherCompleteVisiable = true;
    }

    // 批量
    private string _deleteReason = null;
    private string _deleteDescription = null;
    private bool _DeleteGroupC = false;
    private bool _deleteGroupCompleteVisiable = false;

    /// <summary>
    /// 批量归档打开表单窗口
    /// </summary>
    private void GroupDeleteTeacherForm()
    {
        if (_selected.Count() == 0)
        {
            _errorMessage = "请至少选择一名教师！";
            _errorVisiable = true;
            return;
        }
        _deleteButtonTime = 3;
        ActivateDisableButton();
        _DeleteGroupC = true;
        _deleteReason = null;
        _deleteGroupCompleteVisiable = false;
        _deleteDescription = null;
        _deleteTeacherValid = false;

    }

    /// <summary>
    /// 批量归档确认提交
    /// </summary>
    private void GroupDeleteConfirm()
    {
        if (string.IsNullOrEmpty(_deleteReason))
        {
            _errorMessage = "请输入归档原因！";
            _errorVisiable = true;
            return;
        }
        else
        {
            foreach (var tc in _selected)
            {
                tc.DeleteReason = _deleteReason;
                if (!string.IsNullOrEmpty(_deleteDescription)) tc.Description += "\n 批量归档备注：" + _deleteDescription;
            }
            List<MTeacher> list = _selected.ToList();
            _errorMessage = TeacherService.DeleteTeacher(list);
            if (!string.IsNullOrEmpty(_errorMessage)) { _errorVisiable = true; return; }
            else
            {
                _selected = new List<MTeacher>();
                _deleteGroupCompleteVisiable = true;
            }
        }
        return;
    }

    /*----------------教师离职办理----------------*/
    // 单选
    private bool _resignC = false;
    private bool _resignValid = false;
    private bool _resignCompleteVisiable = false;
    private bool _resignDateC = false;
    private DateOnly _resignDate = DateOnly.MinValue;

    /// <summary>
    /// 单个教师离职打开表单
    /// </summary>
    /// <param name="teacher"></param>
    private void ResignTeacherForm(MTeacher teacher)
    {

        mTeacher = CopyUtil<MTeacher, MTeacher>.Trans(teacher);
        _expiryDate = DateOnly.FromDateTime(mTeacher.ExpiryDate);
        mTeacher.DepartedDate = _expiryDate.ToDateTime(TimeOnly.MinValue);
        _resignC = true;
        _errorVisiable = false;
        _enrollmentDate = DateOnly.FromDateTime(mTeacher.EnrollmentDate);
        _resignDateC = false;
        _resignDate = DateOnly.FromDateTime(mTeacher.ExpiryDate);
        _resignCompleteVisiable = false;
    }

    /// <summary>
    /// 单个教师离职提交表单
    /// </summary>
    private void ResignTeacherSubmit()
    {
        if (mTeacher.DepartedDate == null || mTeacher.DepartedDate == DateTime.MinValue)
        {

            _errorMessage = "请选择离职日期！";
            _errorVisiable = true;
            return;
        }
        if (_resignDate.ToDateTime(TimeOnly.MinValue) < mTeacher.EnrollmentDate)
        {
            _errorMessage = "离职日期早于入职日期！";
            _errorVisiable = true;
            return;
        }
        else if (mTeacher.DepartedDate > mTeacher.ExpiryDate)
        {
            _errorMessage = "离职日期晚于合同到期日期！";
            _errorVisiable = true;
            return;
        }
        _errorMessage = TeacherService.SetResignTeacher(mTeacher);
        if (!string.IsNullOrEmpty(_errorMessage)) _errorVisiable = true;
        else _resignCompleteVisiable = true;
        return;

    }

    // 多选
    private bool _groupResignC = false;
    private bool _groupResignValid = false;
    private bool _groupResign = false;
    private string _groupResignReason = null;
    private string _groupDescription = null;

    /// <summary>
    /// 打开批量设置离职表单
    /// </summary>
    private void GroupResignTeacherForm()
    {
        if (_selected.Count() == 0)
        {
            _errorMessage = "请至少选择一名教师！";
            _errorVisiable = true;
            return;
        }
        _selected = _selected.Where(tc => !(tc.EnrollmentDate >= DateTime.Today || tc.EnrollmentDate == DateTime.MinValue)).ToList();
        mTeacher = new MTeacher();
        _groupResignC = true;
        _groupResignValid = false;
        _errorVisiable = false;
        _resignDateC = false;
        _resignDate = DateOnly.FromDateTime(_selected.Min(x => x.ExpiryDate));
        _resignCompleteVisiable = false;
        _groupResignReason = null;
    }

    /// <summary>
    /// 批量离职提交操作
    /// </summary>
    private void GroupResignTeacherSubmit()
    {

        if (_resignDate == DateOnly.MinValue)
        {

            _errorMessage = "请选择离职日期！";
            _errorVisiable = true;
            return;
        }
        foreach (MTeacher mt in _selected)
        {
            if (_resignDate.ToDateTime(TimeOnly.MinValue) < mt.EnrollmentDate)
            {
                _errorMessage = "出现离职日期早于入职日期！";
                _errorVisiable = true;
                return;
            }
            if (_resignDate.ToDateTime(TimeOnly.MinValue) > mt.ExpiryDate)
            {
                _errorMessage = "出现离职日期晚于合同到期日期！";
                _errorVisiable = true;
                return;
            }
        }
        foreach (MTeacher mt in _selected)
        {
            if (!string.IsNullOrEmpty(_groupResignReason)) mt.DepartedReason += _groupResignReason;
            if (!string.IsNullOrEmpty(_groupDescription)) mt.Description += "\n 批量设置离职时备注：" + _groupDescription;
            mt.DepartedDate = _resignDate.ToDateTime(TimeOnly.MinValue);
            mt.IsDeparted = true;
        }
        List<MTeacher> li = _selected.ToList();
        _errorMessage = TeacherService.SetGroupResignTeacher(li);
        if (!string.IsNullOrEmpty(_errorMessage)) _errorVisiable = true;
        else _resignCompleteVisiable = true;
        return;
    }

    /*----------------编辑教师----------------*/
    private bool _editC = false;
    private bool _editValid = false;
    private bool _editCompleteVisiable = false;

    // 初始化编辑菜单
    private void EditTeacherForm(MTeacher teacher)
    {
        _enrollmentDate = DateOnly.FromDateTime(teacher.EnrollmentDate);
        _expiryDate = DateOnly.FromDateTime(teacher.ExpiryDate);
        mTeacher = CopyUtil<MTeacher, MTeacher>.Trans(teacher);
        _editC = true;
        _errorVisiable = false;
        _editCompleteVisiable = false;
    }

    // 检查表单信息，有误则报错，无误则提交表单
    private void UpdateTeacherInfo()
    {
        // 入职日期和合同到期日期必须同时输入
        if (mTeacher.ExpiryDate != DateTime.MinValue && mTeacher.EnrollmentDate == DateTime.MinValue)
        {

            _errorMessage = "请输入入职日期！";
            _errorVisiable = true;
            return;
        }
        if (mTeacher.EnrollmentDate != DateTime.MinValue && mTeacher.ExpiryDate == DateTime.MinValue)
        {
            _errorMessage = "请输入合同到期日期！";
            _errorVisiable = true;
            return;
        }
        // 合同到期日期不能早于入职日期
        if (mTeacher.EnrollmentDate != DateTime.MinValue && mTeacher.ExpiryDate != DateTime.MinValue && mTeacher.EnrollmentDate >= mTeacher.ExpiryDate)
        {
            _errorMessage = "合同到期日期不能早于入职日期！";
            _errorVisiable = true;
            return;
        }
        _errorMessage = TeacherService.UpdateTeacherInfo(mTeacher);
        if (!string.IsNullOrEmpty(_errorMessage))
        {
            _errorVisiable = true;
            return;
        }
        _editCompleteVisiable = true;

        return;
    }
    /*--------------------------------------------搜索框---------------------------------------------*/

    class SearchModel
    {
        public string? SearchInfo { get; set; }

        public int SchoolLimit { get; set; }

        public bool Deleted { get; set; }

        public bool Resigned { get; set; }
    }
    SearchModel searchModel = new SearchModel();

    /// <summary>
    /// 搜索框内内容发生更改时响应事件
    /// </summary>
    private void onSearch()
    {
        showTeachers.Clear();
        if (string.IsNullOrEmpty(searchModel.SearchInfo) && searchModel.SchoolLimit == 0 && searchModel.Deleted == true && searchModel.Resigned == true)
        {
            showTeachers.AddRange(_teacherInfo);
        }
        else
        {
            foreach (var tec in _teacherInfo)
            {
                // 检查教师信息是否包含搜索关键字或符合学院限制
                if ((string.IsNullOrEmpty(searchModel.SearchInfo)
                || tec.EmployeeID.Contains(searchModel.SearchInfo, StringComparison.OrdinalIgnoreCase)
                || tec.Name.Contains(searchModel.SearchInfo, StringComparison.OrdinalIgnoreCase)
                || (tec.PhoneNumber != null && tec.PhoneNumber.ToString().Contains(searchModel.SearchInfo))
                || ((!string.IsNullOrEmpty(tec.Email)) && tec.Email.Contains(searchModel.SearchInfo))
                || ((!string.IsNullOrEmpty(tec.Description)) && tec.Description.Contains(searchModel.SearchInfo))
                || ((!string.IsNullOrEmpty(tec.JobTitle)) && tec.JobTitle.Contains(searchModel.SearchInfo))
                || ((!string.IsNullOrEmpty(tec.JobPosition)) && tec.JobPosition.Contains(searchModel.SearchInfo))
                || tec.SchoolName.Contains(searchModel.SearchInfo))
                    && (searchModel.SchoolLimit == 0 || tec.SchoolId == searchModel.SchoolLimit)
                    && (searchModel.Deleted == true || tec.IsDeleted == false)
                    && (searchModel.Resigned == true || tec.IsDeparted == false))
                {
                    showTeachers.Add(tec);
                }
            }
        }
        StateHasChanged();
    }

    /*-------------------------------------------------------------------讲台---------------------------------------------------------------*/
    // 讲台信息表格
    private MTeachingClass mTeachingClass = new MTeachingClass();

    /*------------------------------查看讲台列表---------------------------------*/
    /// <summary>
    /// 讲台是否可选择的条件判断
    /// </summary>
    /// <returns></returns>
    private Func<MTeachingClass, bool> ClassSelectable()
    {
        return course =>
        {
            return !course.IsDeleted;
        };
    }
    private MCourse _selectedCourse = null;
    private List<DataTableHeader<MTeachingClass>> _classHeader => new List<DataTableHeader<MTeachingClass>>
    {
    new()
        {
            Text = "课程号",
            Align = DataTableHeaderAlign.Center,
            Sortable = true,
            Value = nameof(MTeachingClass.CourseID),
            Ellipsis = new DataTableEllipsis(),
            Width = 80
        },
        new() {
            Text = "课程名",
            Value = nameof(MTeachingClass.CourseName),
            Align=DataTableHeaderAlign.Center,
            Class="text-no-wrap",
            Sortable=false,
            Ellipsis = new DataTableEllipsis(),
            Width=150
        },
        new() {
            Text = "班级编号",
            Value = nameof(MTeachingClass.ClassPMID),
            Align=DataTableHeaderAlign.Center,
            Class="text-no-wrap",
            Sortable=false,
            Ellipsis = new DataTableEllipsis(),
            Width=100
        },
        new() { Text = "主讲教师",
            Value = nameof(MTeachingClass.TeacherName),
            Align=DataTableHeaderAlign.Center,
            Sortable=false,
            Width=150
        },
        new() {
            Text = "限选人数",
            Value = nameof(MTeachingClass.MaxStuNum),
            Align=DataTableHeaderAlign.Center,
            Class="text-no-wrap",
            Sortable=false,
            Width=80
        },
        new() {
            Text = "选课人数",
            Value = nameof(MTeachingClass.CurStuNum),
            Align=DataTableHeaderAlign.Center,
            Class="text-no-wrap",
            Sortable=false,
            Width=80
        },
        new() {
            Text = "上课地点",
            Value = nameof(MTeachingClass.Location),
            Align=DataTableHeaderAlign.Center,
            Sortable=false,
            Ellipsis = new DataTableEllipsis(),
            Width=150
        },
        new() {
            Text = "上课时间",
            Value = "ClassTime",
            Align=DataTableHeaderAlign.Center,
            Class="text-no-wrap",
            Sortable=false,
            Ellipsis = new DataTableEllipsis(),
            Width=200
        },
        new() {
            Text = "状态",
            Value = "States",
            Align=DataTableHeaderAlign.Center,
            Class="text-no-wrap",
            Sortable=false,
            Ellipsis = new DataTableEllipsis(),
            Width=90
        },
        new() {
            Text = "操作",
            Value = "Actions",
            Sortable = false,
            Align=DataTableHeaderAlign.Center,
            Width = 90
        }
    };
}
